# Interior Agent 시스템 기술 사양서

## 시스템 구성 요소

### 1. 메인 에이전트 (`agent.py`)
- **등록된 도구 수**: 14개
- **역할**: 루트 에이전트, 모든 하위 기능들의 통합 관리

### 2. 핵심 모듈 구조

#### A. 지급 계획 서비스 (`services/construction_payment_planner.py`)
```python
# 주요 함수들
def make_payment_plan(address_query: str) -> str
def find_matching_address(query: str, addresses_data: list) -> dict
def calculate_payment_schedule(total_amount: int, start_date: str) -> list
def format_payment_table(schedule: list, project_name: str) -> str
```

#### B. Firebase 도구 (`tools/firebase_tools.py`)
```python
# 래퍼 함수들
def firebase_query_function(collection: str, query_conditions: dict) -> dict
def firebase_add_document(collection: str, document_data: dict) -> dict
def firebase_update_document(collection: str, doc_id: str, update_data: dict) -> dict
def firebase_delete_document(collection: str, doc_id: str) -> dict
```

#### C. Firebase 클라이언트 (`client/firebase_client.py`)
```python
# HTTP API 클라이언트
class FirebaseClient:
    def query_documents(self, collection: str, conditions: dict) -> list
    def add_document(self, collection: str, data: dict) -> dict
    def update_document(self, collection: str, doc_id: str, data: dict) -> dict
    def delete_document(self, collection: str, doc_id: str) -> bool
```

#### D. 주소 검증 유틸리티 (`utils/address_validator.py`)
```python
# 주소 처리 함수들
def standardize_address(address: str) -> str
def calculate_similarity(addr1: str, addr2: str) -> float
def find_best_match(query: str, address_list: list) -> dict
def validate_address_format(address: str) -> bool
```

## 데이터 플로우

### 지급 계획 생성 프로세스
1. **입력**: 사용자가 "주소 + 분할 지급 계획" 요청
2. **주소 매칭**: `find_matching_address()` 함수로 정확한 주소 찾기
3. **Firebase 조회**: `addresses`, `schedules` 컬렉션에서 정보 수집
4. **금액 계산**: 총액에서 막대금(300만원) 분리, 나머지 1000만원 단위 분할
5. **일정 계산**: 시작일에서 월별 지급일 자동 계산
6. **테이블 포맷**: 보기 좋은 표 형식으로 결과 출력

### Firebase 컬렉션 구조
```
addresses/
├── address (string)
├── description (string)  
├── total_amount (number)
└── project_info (object)

schedules/
├── address (string)
├── start_date (string)
├── payment_dates (array)
└── schedule_info (object)
```

## 주요 알고리즘

### 1. 지급 금액 계산
```python
# 핵심 로직
total_amount = 프로젝트_총액
final_payment = 3000000  # 막대금 300만원
remaining = total_amount - final_payment

# 1000만원 단위 분할
full_payments = remaining // 10000000
last_payment = remaining % 10000000

if last_payment > 0:
    installments = [10000000] * full_payments + [last_payment] + [final_payment]
else:
    installments = [10000000] * (full_payments - 1) + [10000000 + final_payment]
```

### 2. 주소 매칭 알고리즘
```python
# 다단계 매칭 프로세스
1. 정확한 문자열 매치 (address 필드)
2. 정확한 문자열 매치 (description 필드)  
3. 유사도 기반 매치 (임계값: 0.8)
4. 부분 문자열 매치
5. 오타 보정 후 재매치
```

### 3. 일정 계산
```python
# 월별 지급일 자동 계산
base_date = datetime.strptime(start_date, "%Y-%m-%d")
payment_dates = []

for i in range(len(installments)):
    next_date = base_date + relativedelta(months=i)
    payment_dates.append(next_date.strftime("%Y-%m-%d"))
```

## 에러 처리 및 검증

### 1. Firebase 응답 검증
```python
# 다중 조건 검증
def validate_firebase_response(response):
    checks = [
        response.get('success', False),
        'documents' in response,
        len(response.get('documents', [])) > 0,
        response.get('status') == 'success'
    ]
    return any(checks)
```

### 2. 주소 검증
```python
# 주소 형식 검증
def validate_address_format(address):
    patterns = [
        r'.*동.*호$',  # 동호수 패턴
        r'.*아파트.*$',  # 아파트 패턴
        r'.*[0-9]+차.*$'  # 차수 패턴
    ]
    return any(re.match(pattern, address) for pattern in patterns)
```

### 3. 금액 검증
```python
# 금액 유효성 검사
def validate_amount(amount):
    return (
        isinstance(amount, (int, float)) and
        amount > 0 and
        amount >= 3000000  # 최소 막대금 이상
    )
```

## 성능 최적화

### 1. 캐싱 전략
- 주소 매칭 결과 메모리 캐싱
- Firebase 쿼리 결과 임시 저장
- 계산 결과 재사용

### 2. 비동기 처리
- Firebase 멀티 컬렉션 동시 조회
- 주소 검증과 금액 계산 병렬 처리

### 3. 메모리 관리
- 대용량 문서 배열 스트리밍 처리
- 불필요한 데이터 조기 해제

## 보안 고려사항

### 1. 데이터 접근 제어
- Firebase 규칙 기반 접근 제어
- API 키 환경 변수 관리
- 민감 정보 로그 제외

### 2. 입력 검증
```python
# 사용자 입력 정화
def sanitize_input(user_input):
    # SQL 인젝션 방지
    # XSS 공격 방지
    # 특수 문자 이스케이프
    return cleaned_input
```

## ADK Web 호환성

### 1. 환경 대응
```python
# Import 호환성
try:
    from .client.firebase_client import FirebaseClient
except ImportError:
    from client.firebase_client import FirebaseClient
```

### 2. 함수 시그니처 최적화
- 단순한 파라미터 타입 사용
- 복잡한 객체 대신 기본 타입 선호
- 명시적 타입 힌트 제공

### 3. 에러 처리 강화
```python
# 상세한 디버그 정보
def enhanced_error_handling():
    try:
        # 메인 로직
        pass
    except Exception as e:
        error_info = {
            'error_type': type(e).__name__,
            'error_message': str(e),
            'traceback': traceback.format_exc(),
            'timestamp': datetime.now().isoformat()
        }
        return json.dumps(error_info, ensure_ascii=False, indent=2)
```

## 테스트 커버리지

### 1. 단위 테스트
- 각 함수별 개별 테스트
- 경계값 테스트
- 예외 상황 테스트

### 2. 통합 테스트
- Firebase 연동 테스트
- 전체 플로우 테스트
- ADK Web 환경 테스트

### 3. 성능 테스트
- 대용량 데이터 처리 테스트
- 동시 요청 처리 테스트
- 메모리 사용량 모니터링

---
**문서 버전**: 1.0
**최종 업데이트**: 2024년 현재
**기술 스택**: Python, Firebase, Google ADK
**호환성**: ADK Web, Local Environment 