# Interior Agent 시스템 기술 사양서

## 시스템 구성 요소

### 1. 메인 에이전트 (`agent.py`)
- **등록된 도구 수**: 14개
- **역할**: 루트 에이전트, 모든 하위 기능들의 통합 관리

### 2. 핵심 모듈 구조

#### A. 지급 계획 서비스 (`services/construction_payment_planner.py`)
```python
# 주요 함수들
def make_payment_plan(address_query: str) -> str
def find_matching_address(query: str, addressesJson_data: list) -> dict
def calculate_payment_schedule(total_amount: int, start_date: str) -> list
def format_payment_table(schedule: list, project_name: str) -> str
```

#### B. Firebase 도구 (`tools/firebase_tools.py`)
```python
# 래퍼 함수들
def firebase_query_function(collection: str, query_conditions: dict) -> dict
def firebase_add_document(collection: str, document_data: dict) -> dict
def firebase_update_document(collection: str, doc_id: str, update_data: dict) -> dict
def firebase_delete_document(collection: str, doc_id: str) -> dict
```

#### C. Firebase 클라이언트 (`client/firebase_client.py`)
```python
# HTTP API 클라이언트
class FirebaseClient:
    def query_documents(self, collection: str, conditions: dict) -> list
    def add_document(self, collection: str, data: dict) -> dict
    def update_document(self, collection: str, doc_id: str, data: dict) -> dict
    def delete_document(self, collection: str, doc_id: str) -> bool
```

#### D. 주소 검증 유틸리티 (`utils/address_validator.py`)
```python
# 주소 처리 함수들
def standardize_address(address: str) -> str
def calculate_similarity(addr1: str, addr2: str) -> float
def find_best_match(query: str, address_list: list) -> dict
def validate_address_format(address: str) -> bool
```

## 데이터 플로우

### 지급 계획 생성 프로세스
1. **입력**: 사용자가 "주소 + 분할 지급 계획" 요청
2. **주소 매칭**: `find_matching_address()` 함수로 정확한 주소 찾기
3. **Firebase 조회**: `addressesJson`, `schedules` 컬렉션에서 정보 수집
4. **금액 계산**: 총액에서 막대금(300만원) 분리, 나머지 1000만원 단위 분할
5. **일정 계산**: 시작일에서 월별 지급일 자동 계산
6. **테이블 포맷**: 보기 좋은 표 형식으로 결과 출력

### Firebase 컬렉션 구조
```
addressesJson/
├── address (string)
├── description (string)  
├── total_amount (number)
└── project_info (object)

schedules/
├── address (string)
├── start_date (string)
├── payment_dates (array)
└── schedule_info (object)
```

## 주요 알고리즘

### 1. 지급 금액 계산
```python
# 핵심 로직
total_amount = 프로젝트_총액
final_payment = 3000000  # 막대금 300만원
remaining = total_amount - final_payment

# 1000만원 단위 분할
full_payments = remaining // 10000000
last_payment = remaining % 10000000

if last_payment > 0:
    installments = [10000000] * full_payments + [last_payment] + [final_payment]
else:
    installments = [10000000] * (full_payments - 1) + [10000000 + final_payment]
```

### 2. 주소 매칭 알고리즘
```python
# 다단계 매칭 프로세스
1. 정확한 문자열 매치 (address 필드)
2. 정확한 문자열 매치 (description 필드)  
3. 유사도 기반 매치 (임계값: 0.8)
4. 부분 문자열 매치
5. 오타 보정 후 재매치
```

### 3. 일정 계산
```python
# 월별 지급일 자동 계산
base_date = datetime.strptime(start_date, "%Y-%m-%d")
payment_dates = []

for i in range(len(installments)):
    next_date = base_date + relativedelta(months=i)
    payment_dates.append(next_date.strftime("%Y-%m-%d"))
```

## 에러 처리 및 검증

### 1. Firebase 응답 검증
```python
# 다중 조건 검증
def validate_firebase_response(response):
    checks = [
        response.get('success', False),
        'documents' in response,
        len(response.get('documents', [])) > 0,
        response.get('status') == 'success'
    ]
    return any(checks)
```

### 2. 주소 검증
```python
# 주소 형식 검증
def validate_address_format(address):
    patterns = [
        r'.*동.*호$',  # 동호수 패턴
        r'.*아파트.*$',  # 아파트 패턴
        r'.*[0-9]+차.*$'  # 차수 패턴
    ]
    return any(re.match(pattern, address) for pattern in patterns)
```

### 3. 금액 검증
```python
# 금액 유효성 검사
def validate_amount(amount):
    return (
        isinstance(amount, (int, float)) and
        amount > 0 and
        amount >= 3000000  # 최소 막대금 이상
    )
```

## 성능 최적화

### 1. 캐싱 전략
- 주소 매칭 결과 메모리 캐싱
- Firebase 쿼리 결과 임시 저장
- 계산 결과 재사용

### 2. 비동기 처리
- Firebase 멀티 컬렉션 동시 조회
- 주소 검증과 금액 계산 병렬 처리

### 3. 메모리 관리
- 대용량 문서 배열 스트리밍 처리
- 불필요한 데이터 조기 해제

## 보안 고려사항

### 1. 데이터 접근 제어
- Firebase 규칙 기반 접근 제어
- API 키 환경 변수 관리
- 민감 정보 로그 제외

### 2. 입력 검증
```python
# 사용자 입력 정화
def sanitize_input(user_input):
    # SQL 인젝션 방지
    # XSS 공격 방지
    # 특수 문자 이스케이프
    return cleaned_input
```

## ADK Web 호환성

### 1. 환경 대응
```python
# Import 호환성
try:
    from .client.firebase_client import FirebaseClient
except ImportError:
    from client.firebase_client import FirebaseClient
```

### 2. 함수 시그니처 최적화
- 단순한 파라미터 타입 사용
- 복잡한 객체 대신 기본 타입 선호
- 명시적 타입 힌트 제공

### 3. 에러 처리 강화
```python
# 상세한 디버그 정보
def enhanced_error_handling():
    try:
        # 메인 로직
        pass
    except Exception as e:
        error_info = {
            'error_type': type(e).__name__,
            'error_message': str(e),
            'traceback': traceback.format_exc(),
            'timestamp': datetime.now().isoformat()
        }
        return json.dumps(error_info, ensure_ascii=False, indent=2)
```

## 테스트 커버리지

### 1. 단위 테스트
- 각 함수별 개별 테스트
- 경계값 테스트
- 예외 상황 테스트

### 2. 통합 테스트
- Firebase 연동 테스트
- 전체 플로우 테스트
- ADK Web 환경 테스트

### 3. 성능 테스트
- 대용량 데이터 처리 테스트
- 동시 요청 처리 테스트
- 메모리 사용량 모니터링

## 🆕 주소 관리 CRUD 시스템 (v1.2.1)

### 📂 새로운 agent/ 폴더 구조
```
📂 agent/
├── __init__.py                      # 패키지 초기화 및 export
└── address_management_agent.py      # 주소 CRUD 전담 에이전트
```

### 🛠️ CRUD 기능들

#### 1. **주소 등록** (`register_new_address`)
```python
# 기능: 새 주소를 addressesJson 컬렉션에 등록
# 특징: 주소만 필수, 나머지는 선택, 타임스탬프 ID 자동 생성

# 최소 등록 (주소만)
address_data = {"address": "경기 용인시 수지구 풍덕천동 월배아이파크 1차 109동 2401호"}
result = register_new_address(address_data)
# 생성되는 문서 ID: "1749463142812" 형식 (13자리 타임스탬프)

# 전체 정보 등록 (선택 사항)
full_data = {
    "address": "경기 용인시 수지구 풍덕천동 월배아이파크 1차 109동 2401호",  # 필수
    "description": "월배아이파크 1차",         # 선택
    "totalAmount": 14245000,                  # 선택
    "startDate": "2024-01-15",               # 선택
    "endDate": "2024-03-15",                 # 선택
    "phoneLastFourDigits": "1234",           # 선택
    "clientName": "홍길동"                    # 선택
}
result = register_new_address(full_data)
```

#### 2. **주소 수정** (`update_existing_address`)
```python  
# 기능: 기존 주소 정보 부분 업데이트
# 특징: 문서 존재 확인, 주소 변경 시 자동 재검증
update_data = {"totalAmount": 15000000, "clientName": "김철수"}
result = update_existing_address("doc_id_123", update_data)
```

#### 3. **주소 삭제** (`delete_address_record`)
```python
# 기능: 주소 레코드 삭제 (관련 데이터 확인 포함)
# 특징: 안전 삭제 (관련 schedules 체크), 강제 삭제 옵션
result = delete_address_record("doc_id_123", force=False)
```

#### 4. **주소 목록 조회** (`list_all_addresses`)
```python
# 기능: 모든 주소 목록 조회 (기본/상세 모드)
# 특징: 페이징 지원, 선택적 상세 정보 포함
result = list_all_addresses(limit=100, include_details=True)
```

#### 5. **주소 검색** (`search_addresses_by_keyword`)
```python
# 기능: 키워드 기반 유사도 검색
# 특징: 유사도 임계값 조정 가능, 매치 스코어 제공
result = search_addresses_by_keyword("월배아이파크", threshold=0.6)
```

### 🔗 Firebase CRUD 통합

#### Firebase 클라이언트 확장
```python
# 새로 추가된 Firebase CRUD 메소드들
firebase_client.add_document(collection_path, document_data, document_id)
firebase_client.update_document(document_path, update_data, merge=True)  
firebase_client.delete_document(document_path)
```

### 🤖 AI 에이전트 통합

#### 메인 에이전트 확장 (`agent_main.py`)
```python
# 새로운 CRUD 도구들이 추가된 tools 배열
tools = [
    # ... 기존 도구들
    register_new_address,           # 주소 등록
    update_existing_address,        # 주소 수정
    delete_address_record,          # 주소 삭제  
    list_all_addresses,             # 주소 목록
    search_addresses_by_keyword     # 주소 검색
]
```

### ⚡ **주요 개선 사항 (v1.2.1)**

| 개선 항목 | 기존 | 개선 후 |
|-----------|------|---------|
| **필수 필드** | 모든 정보 필요 | 주소만 필수 |
| **문서 ID** | Firebase 자동 생성 | 타임스탬프 형식 (예: 1749463142812) |
| **사용성** | 복잡한 정보 입력 | 간단한 주소만으로 즉시 등록 |
| **유연성** | 경직된 구조 | 점진적 정보 추가 가능 |

### 🔄 기존 시스템과의 분리

| 구분 | 기존 (`services/`) | 신규 (`agent/`) |
|------|-------------------|-----------------|
| **역할** | 복합 비즈니스 로직 | 단순 CRUD 행동 |
| **복잡도** | 높음 (다중 컬렉션 조회, 계산) | 낮음 (단일 동작) |
| **예시** | `make_payment_plan()` | `register_new_address()` |
| **의존성** | services ↔ utils ↔ tools | agent → utils → client |

### 🛡️ 보안 및 검증 강화

#### 1. **입력 검증**
- **유연한 필드 정책**: 주소만 필수, 나머지는 모두 선택 사항
- 주소 형식 검증 (AddressValidator 활용)
- 데이터 타입 및 범위 검증
- **자동 ID 생성**: 타임스탬프 기반 문서 ID (예: "1749463142812")

#### 2. **중복 방지**
- 유사도 기반 중복 주소 탐지 (임계값: 0.8)
- 기존 문서와의 충돌 방지

#### 3. **관련 데이터 보호**  
- 삭제 전 관련 schedules 컬렉션 확인
- 안전 삭제 vs 강제 삭제 옵션 제공

---
**문서 버전**: 1.2.1 (주소 관리 CRUD 추가)
**최종 업데이트**: 2024년 현재  
**기술 스택**: Python, Firebase, Google ADK
**호환성**: ADK Web, Local Environment 