# Interior Agent ì‹œìŠ¤í…œ ê¸°ìˆ  ì‚¬ì–‘ì„œ

## ì‹œìŠ¤í…œ êµ¬ì„± ìš”ì†Œ

### 1. ë©”ì¸ ì—ì´ì „íŠ¸ (`agent.py`)
- **ë“±ë¡ëœ ë„êµ¬ ìˆ˜**: 14ê°œ
- **ì—­í• **: ë£¨íŠ¸ ì—ì´ì „íŠ¸, ëª¨ë“  í•˜ìœ„ ê¸°ëŠ¥ë“¤ì˜ í†µí•© ê´€ë¦¬

### 2. í•µì‹¬ ëª¨ë“ˆ êµ¬ì¡°

#### A. ì§€ê¸‰ ê³„íš ì„œë¹„ìŠ¤ (`services/construction_payment_planner.py`)
```python
# ì£¼ìš” í•¨ìˆ˜ë“¤
def make_payment_plan(address_query: str) -> str
def find_matching_address(query: str, addressesJson_data: list) -> dict
def calculate_payment_schedule(total_amount: int, start_date: str) -> list
def format_payment_table(schedule: list, project_name: str) -> str
```

#### B. Firebase ë„êµ¬ (`tools/firebase_tools.py`)
```python
# ë˜í¼ í•¨ìˆ˜ë“¤
def firebase_query_function(collection: str, query_conditions: dict) -> dict
def firebase_add_document(collection: str, document_data: dict) -> dict
def firebase_update_document(collection: str, doc_id: str, update_data: dict) -> dict
def firebase_delete_document(collection: str, doc_id: str) -> dict
```

#### C. Firebase í´ë¼ì´ì–¸íŠ¸ (`client/firebase_client.py`)
```python
# HTTP API í´ë¼ì´ì–¸íŠ¸
class FirebaseClient:
    def query_documents(self, collection: str, conditions: dict) -> list
    def add_document(self, collection: str, data: dict) -> dict
    def update_document(self, collection: str, doc_id: str, data: dict) -> dict
    def delete_document(self, collection: str, doc_id: str) -> bool
```

#### D. ì£¼ì†Œ ê²€ì¦ ìœ í‹¸ë¦¬í‹° (`utils/address_validator.py`)
```python
# ì£¼ì†Œ ì²˜ë¦¬ í•¨ìˆ˜ë“¤
def standardize_address(address: str) -> str
def calculate_similarity(addr1: str, addr2: str) -> float
def find_best_match(query: str, address_list: list) -> dict
def validate_address_format(address: str) -> bool
```

## ë°ì´í„° í”Œë¡œìš°

### ì§€ê¸‰ ê³„íš ìƒì„± í”„ë¡œì„¸ìŠ¤
1. **ì…ë ¥**: ì‚¬ìš©ìê°€ "ì£¼ì†Œ + ë¶„í•  ì§€ê¸‰ ê³„íš" ìš”ì²­
2. **ì£¼ì†Œ ë§¤ì¹­**: `find_matching_address()` í•¨ìˆ˜ë¡œ ì •í™•í•œ ì£¼ì†Œ ì°¾ê¸°
3. **Firebase ì¡°íšŒ**: `addressesJson`, `schedules` ì»¬ë ‰ì…˜ì—ì„œ ì •ë³´ ìˆ˜ì§‘
4. **ê¸ˆì•¡ ê³„ì‚°**: ì´ì•¡ì—ì„œ ë§‰ëŒ€ê¸ˆ(300ë§Œì›) ë¶„ë¦¬, ë‚˜ë¨¸ì§€ 1000ë§Œì› ë‹¨ìœ„ ë¶„í• 
5. **ì¼ì • ê³„ì‚°**: ì‹œì‘ì¼ì—ì„œ ì›”ë³„ ì§€ê¸‰ì¼ ìë™ ê³„ì‚°
6. **í…Œì´ë¸” í¬ë§·**: ë³´ê¸° ì¢‹ì€ í‘œ í˜•ì‹ìœ¼ë¡œ ê²°ê³¼ ì¶œë ¥

### Firebase ì»¬ë ‰ì…˜ êµ¬ì¡°
```
addressesJson/
â”œâ”€â”€ address (string)
â”œâ”€â”€ description (string)  
â”œâ”€â”€ total_amount (number)
â””â”€â”€ project_info (object)

schedules/
â”œâ”€â”€ address (string)
â”œâ”€â”€ start_date (string)
â”œâ”€â”€ payment_dates (array)
â””â”€â”€ schedule_info (object)
```

## ì£¼ìš” ì•Œê³ ë¦¬ì¦˜

### 1. ì§€ê¸‰ ê¸ˆì•¡ ê³„ì‚°
```python
# í•µì‹¬ ë¡œì§
total_amount = í”„ë¡œì íŠ¸_ì´ì•¡
final_payment = 3000000  # ë§‰ëŒ€ê¸ˆ 300ë§Œì›
remaining = total_amount - final_payment

# 1000ë§Œì› ë‹¨ìœ„ ë¶„í• 
full_payments = remaining // 10000000
last_payment = remaining % 10000000

if last_payment > 0:
    installments = [10000000] * full_payments + [last_payment] + [final_payment]
else:
    installments = [10000000] * (full_payments - 1) + [10000000 + final_payment]
```

### 2. ì£¼ì†Œ ë§¤ì¹­ ì•Œê³ ë¦¬ì¦˜
```python
# ë‹¤ë‹¨ê³„ ë§¤ì¹­ í”„ë¡œì„¸ìŠ¤
1. ì •í™•í•œ ë¬¸ìì—´ ë§¤ì¹˜ (address í•„ë“œ)
2. ì •í™•í•œ ë¬¸ìì—´ ë§¤ì¹˜ (description í•„ë“œ)  
3. ìœ ì‚¬ë„ ê¸°ë°˜ ë§¤ì¹˜ (ì„ê³„ê°’: 0.8)
4. ë¶€ë¶„ ë¬¸ìì—´ ë§¤ì¹˜
5. ì˜¤íƒ€ ë³´ì • í›„ ì¬ë§¤ì¹˜
```

### 3. ì¼ì • ê³„ì‚°
```python
# ì›”ë³„ ì§€ê¸‰ì¼ ìë™ ê³„ì‚°
base_date = datetime.strptime(start_date, "%Y-%m-%d")
payment_dates = []

for i in range(len(installments)):
    next_date = base_date + relativedelta(months=i)
    payment_dates.append(next_date.strftime("%Y-%m-%d"))
```

## ì—ëŸ¬ ì²˜ë¦¬ ë° ê²€ì¦

### 1. Firebase ì‘ë‹µ ê²€ì¦
```python
# ë‹¤ì¤‘ ì¡°ê±´ ê²€ì¦
def validate_firebase_response(response):
    checks = [
        response.get('success', False),
        'documents' in response,
        len(response.get('documents', [])) > 0,
        response.get('status') == 'success'
    ]
    return any(checks)
```

### 2. ì£¼ì†Œ ê²€ì¦
```python
# ì£¼ì†Œ í˜•ì‹ ê²€ì¦
def validate_address_format(address):
    patterns = [
        r'.*ë™.*í˜¸$',  # ë™í˜¸ìˆ˜ íŒ¨í„´
        r'.*ì•„íŒŒíŠ¸.*$',  # ì•„íŒŒíŠ¸ íŒ¨í„´
        r'.*[0-9]+ì°¨.*$'  # ì°¨ìˆ˜ íŒ¨í„´
    ]
    return any(re.match(pattern, address) for pattern in patterns)
```

### 3. ê¸ˆì•¡ ê²€ì¦
```python
# ê¸ˆì•¡ ìœ íš¨ì„± ê²€ì‚¬
def validate_amount(amount):
    return (
        isinstance(amount, (int, float)) and
        amount > 0 and
        amount >= 3000000  # ìµœì†Œ ë§‰ëŒ€ê¸ˆ ì´ìƒ
    )
```

## ì„±ëŠ¥ ìµœì í™”

### 1. ìºì‹± ì „ëµ
- ì£¼ì†Œ ë§¤ì¹­ ê²°ê³¼ ë©”ëª¨ë¦¬ ìºì‹±
- Firebase ì¿¼ë¦¬ ê²°ê³¼ ì„ì‹œ ì €ì¥
- ê³„ì‚° ê²°ê³¼ ì¬ì‚¬ìš©

### 2. ë¹„ë™ê¸° ì²˜ë¦¬
- Firebase ë©€í‹° ì»¬ë ‰ì…˜ ë™ì‹œ ì¡°íšŒ
- ì£¼ì†Œ ê²€ì¦ê³¼ ê¸ˆì•¡ ê³„ì‚° ë³‘ë ¬ ì²˜ë¦¬

### 3. ë©”ëª¨ë¦¬ ê´€ë¦¬
- ëŒ€ìš©ëŸ‰ ë¬¸ì„œ ë°°ì—´ ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬
- ë¶ˆí•„ìš”í•œ ë°ì´í„° ì¡°ê¸° í•´ì œ

## ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### 1. ë°ì´í„° ì ‘ê·¼ ì œì–´
- Firebase ê·œì¹™ ê¸°ë°˜ ì ‘ê·¼ ì œì–´
- API í‚¤ í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬
- ë¯¼ê° ì •ë³´ ë¡œê·¸ ì œì™¸

### 2. ì…ë ¥ ê²€ì¦
```python
# ì‚¬ìš©ì ì…ë ¥ ì •í™”
def sanitize_input(user_input):
    # SQL ì¸ì ì…˜ ë°©ì§€
    # XSS ê³µê²© ë°©ì§€
    # íŠ¹ìˆ˜ ë¬¸ì ì´ìŠ¤ì¼€ì´í”„
    return cleaned_input
```

## ADK Web í˜¸í™˜ì„±

### 1. í™˜ê²½ ëŒ€ì‘
```python
# Import í˜¸í™˜ì„±
try:
    from .client.firebase_client import FirebaseClient
except ImportError:
    from client.firebase_client import FirebaseClient
```

### 2. í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ ìµœì í™”
- ë‹¨ìˆœí•œ íŒŒë¼ë¯¸í„° íƒ€ì… ì‚¬ìš©
- ë³µì¡í•œ ê°ì²´ ëŒ€ì‹  ê¸°ë³¸ íƒ€ì… ì„ í˜¸
- ëª…ì‹œì  íƒ€ì… íŒíŠ¸ ì œê³µ

### 3. ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”
```python
# ìƒì„¸í•œ ë””ë²„ê·¸ ì •ë³´
def enhanced_error_handling():
    try:
        # ë©”ì¸ ë¡œì§
        pass
    except Exception as e:
        error_info = {
            'error_type': type(e).__name__,
            'error_message': str(e),
            'traceback': traceback.format_exc(),
            'timestamp': datetime.now().isoformat()
        }
        return json.dumps(error_info, ensure_ascii=False, indent=2)
```

## í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€

### 1. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- ê° í•¨ìˆ˜ë³„ ê°œë³„ í…ŒìŠ¤íŠ¸
- ê²½ê³„ê°’ í…ŒìŠ¤íŠ¸
- ì˜ˆì™¸ ìƒí™© í…ŒìŠ¤íŠ¸

### 2. í†µí•© í…ŒìŠ¤íŠ¸
- Firebase ì—°ë™ í…ŒìŠ¤íŠ¸
- ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸
- ADK Web í™˜ê²½ í…ŒìŠ¤íŠ¸

### 3. ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
- ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬ í…ŒìŠ¤íŠ¸
- ë™ì‹œ ìš”ì²­ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸
- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§

## ğŸ†• ì£¼ì†Œ ê´€ë¦¬ CRUD ì‹œìŠ¤í…œ (v1.2.1)

### ğŸ“‚ ìƒˆë¡œìš´ agent/ í´ë” êµ¬ì¡°
```
ğŸ“‚ agent/
â”œâ”€â”€ __init__.py                      # íŒ¨í‚¤ì§€ ì´ˆê¸°í™” ë° export
â””â”€â”€ address_management_agent.py      # ì£¼ì†Œ CRUD ì „ë‹´ ì—ì´ì „íŠ¸
```

### ğŸ› ï¸ CRUD ê¸°ëŠ¥ë“¤

#### 1. **ì£¼ì†Œ ë“±ë¡** (`register_new_address`)
```python
# ê¸°ëŠ¥: ìƒˆ ì£¼ì†Œë¥¼ addressesJson ì»¬ë ‰ì…˜ì— ë“±ë¡
# íŠ¹ì§•: ì£¼ì†Œë§Œ í•„ìˆ˜, ë‚˜ë¨¸ì§€ëŠ” ì„ íƒ, íƒ€ì„ìŠ¤íƒ¬í”„ ID ìë™ ìƒì„±

# ìµœì†Œ ë“±ë¡ (ì£¼ì†Œë§Œ)
address_data = {"address": "ê²½ê¸° ìš©ì¸ì‹œ ìˆ˜ì§€êµ¬ í’ë•ì²œë™ ì›”ë°°ì•„ì´íŒŒí¬ 1ì°¨ 109ë™ 2401í˜¸"}
result = register_new_address(address_data)
# ìƒì„±ë˜ëŠ” ë¬¸ì„œ ID: "1749463142812" í˜•ì‹ (13ìë¦¬ íƒ€ì„ìŠ¤íƒ¬í”„)

# ì „ì²´ ì •ë³´ ë“±ë¡ (ì„ íƒ ì‚¬í•­)
full_data = {
    "address": "ê²½ê¸° ìš©ì¸ì‹œ ìˆ˜ì§€êµ¬ í’ë•ì²œë™ ì›”ë°°ì•„ì´íŒŒí¬ 1ì°¨ 109ë™ 2401í˜¸",  # í•„ìˆ˜
    "description": "ì›”ë°°ì•„ì´íŒŒí¬ 1ì°¨",         # ì„ íƒ
    "totalAmount": 14245000,                  # ì„ íƒ
    "startDate": "2024-01-15",               # ì„ íƒ
    "endDate": "2024-03-15",                 # ì„ íƒ
    "phoneLastFourDigits": "1234",           # ì„ íƒ
    "clientName": "í™ê¸¸ë™"                    # ì„ íƒ
}
result = register_new_address(full_data)
```

#### 2. **ì£¼ì†Œ ìˆ˜ì •** (`update_existing_address`)
```python  
# ê¸°ëŠ¥: ê¸°ì¡´ ì£¼ì†Œ ì •ë³´ ë¶€ë¶„ ì—…ë°ì´íŠ¸
# íŠ¹ì§•: ë¬¸ì„œ ì¡´ì¬ í™•ì¸, ì£¼ì†Œ ë³€ê²½ ì‹œ ìë™ ì¬ê²€ì¦
update_data = {"totalAmount": 15000000, "clientName": "ê¹€ì² ìˆ˜"}
result = update_existing_address("doc_id_123", update_data)
```

#### 3. **ì£¼ì†Œ ì‚­ì œ** (`delete_address_record`)
```python
# ê¸°ëŠ¥: ì£¼ì†Œ ë ˆì½”ë“œ ì‚­ì œ (ê´€ë ¨ ë°ì´í„° í™•ì¸ í¬í•¨)
# íŠ¹ì§•: ì•ˆì „ ì‚­ì œ (ê´€ë ¨ schedules ì²´í¬), ê°•ì œ ì‚­ì œ ì˜µì…˜
result = delete_address_record("doc_id_123", force=False)
```

#### 4. **ì£¼ì†Œ ëª©ë¡ ì¡°íšŒ** (`list_all_addresses`)
```python
# ê¸°ëŠ¥: ëª¨ë“  ì£¼ì†Œ ëª©ë¡ ì¡°íšŒ (ê¸°ë³¸/ìƒì„¸ ëª¨ë“œ)
# íŠ¹ì§•: í˜ì´ì§• ì§€ì›, ì„ íƒì  ìƒì„¸ ì •ë³´ í¬í•¨
result = list_all_addresses(limit=100, include_details=True)
```

#### 5. **ì£¼ì†Œ ê²€ìƒ‰** (`search_addresses_by_keyword`)
```python
# ê¸°ëŠ¥: í‚¤ì›Œë“œ ê¸°ë°˜ ìœ ì‚¬ë„ ê²€ìƒ‰
# íŠ¹ì§•: ìœ ì‚¬ë„ ì„ê³„ê°’ ì¡°ì • ê°€ëŠ¥, ë§¤ì¹˜ ìŠ¤ì½”ì–´ ì œê³µ
result = search_addresses_by_keyword("ì›”ë°°ì•„ì´íŒŒí¬", threshold=0.6)
```

### ğŸ”— Firebase CRUD í†µí•©

#### Firebase í´ë¼ì´ì–¸íŠ¸ í™•ì¥
```python
# ìƒˆë¡œ ì¶”ê°€ëœ Firebase CRUD ë©”ì†Œë“œë“¤
firebase_client.add_document(collection_path, document_data, document_id)
firebase_client.update_document(document_path, update_data, merge=True)  
firebase_client.delete_document(document_path)
```

### ğŸ¤– AI ì—ì´ì „íŠ¸ í†µí•©

#### ë©”ì¸ ì—ì´ì „íŠ¸ í™•ì¥ (`agent_main.py`)
```python
# ìƒˆë¡œìš´ CRUD ë„êµ¬ë“¤ì´ ì¶”ê°€ëœ tools ë°°ì—´
tools = [
    # ... ê¸°ì¡´ ë„êµ¬ë“¤
    register_new_address,           # ì£¼ì†Œ ë“±ë¡
    update_existing_address,        # ì£¼ì†Œ ìˆ˜ì •
    delete_address_record,          # ì£¼ì†Œ ì‚­ì œ  
    list_all_addresses,             # ì£¼ì†Œ ëª©ë¡
    search_addresses_by_keyword     # ì£¼ì†Œ ê²€ìƒ‰
]
```

### âš¡ **ì£¼ìš” ê°œì„  ì‚¬í•­ (v1.2.1)**

| ê°œì„  í•­ëª© | ê¸°ì¡´ | ê°œì„  í›„ |
|-----------|------|---------|
| **í•„ìˆ˜ í•„ë“œ** | ëª¨ë“  ì •ë³´ í•„ìš” | ì£¼ì†Œë§Œ í•„ìˆ˜ |
| **ë¬¸ì„œ ID** | Firebase ìë™ ìƒì„± | íƒ€ì„ìŠ¤íƒ¬í”„ í˜•ì‹ (ì˜ˆ: 1749463142812) |
| **ì‚¬ìš©ì„±** | ë³µì¡í•œ ì •ë³´ ì…ë ¥ | ê°„ë‹¨í•œ ì£¼ì†Œë§Œìœ¼ë¡œ ì¦‰ì‹œ ë“±ë¡ |
| **ìœ ì—°ì„±** | ê²½ì§ëœ êµ¬ì¡° | ì ì§„ì  ì •ë³´ ì¶”ê°€ ê°€ëŠ¥ |

### ğŸ”„ ê¸°ì¡´ ì‹œìŠ¤í…œê³¼ì˜ ë¶„ë¦¬

| êµ¬ë¶„ | ê¸°ì¡´ (`services/`) | ì‹ ê·œ (`agent/`) |
|------|-------------------|-----------------|
| **ì—­í• ** | ë³µí•© ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ | ë‹¨ìˆœ CRUD í–‰ë™ |
| **ë³µì¡ë„** | ë†’ìŒ (ë‹¤ì¤‘ ì»¬ë ‰ì…˜ ì¡°íšŒ, ê³„ì‚°) | ë‚®ìŒ (ë‹¨ì¼ ë™ì‘) |
| **ì˜ˆì‹œ** | `make_payment_plan()` | `register_new_address()` |
| **ì˜ì¡´ì„±** | services â†” utils â†” tools | agent â†’ utils â†’ client |

### ğŸ›¡ï¸ ë³´ì•ˆ ë° ê²€ì¦ ê°•í™”

#### 1. **ì…ë ¥ ê²€ì¦**
- **ìœ ì—°í•œ í•„ë“œ ì •ì±…**: ì£¼ì†Œë§Œ í•„ìˆ˜, ë‚˜ë¨¸ì§€ëŠ” ëª¨ë‘ ì„ íƒ ì‚¬í•­
- ì£¼ì†Œ í˜•ì‹ ê²€ì¦ (AddressValidator í™œìš©)
- ë°ì´í„° íƒ€ì… ë° ë²”ìœ„ ê²€ì¦
- **ìë™ ID ìƒì„±**: íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë°˜ ë¬¸ì„œ ID (ì˜ˆ: "1749463142812")

#### 2. **ì¤‘ë³µ ë°©ì§€**
- ìœ ì‚¬ë„ ê¸°ë°˜ ì¤‘ë³µ ì£¼ì†Œ íƒì§€ (ì„ê³„ê°’: 0.8)
- ê¸°ì¡´ ë¬¸ì„œì™€ì˜ ì¶©ëŒ ë°©ì§€

#### 3. **ê´€ë ¨ ë°ì´í„° ë³´í˜¸**  
- ì‚­ì œ ì „ ê´€ë ¨ schedules ì»¬ë ‰ì…˜ í™•ì¸
- ì•ˆì „ ì‚­ì œ vs ê°•ì œ ì‚­ì œ ì˜µì…˜ ì œê³µ

---
**ë¬¸ì„œ ë²„ì „**: 1.2.1 (ì£¼ì†Œ ê´€ë¦¬ CRUD ì¶”ê°€)
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2024ë…„ í˜„ì¬  
**ê¸°ìˆ  ìŠ¤íƒ**: Python, Firebase, Google ADK
**í˜¸í™˜ì„±**: ADK Web, Local Environment 