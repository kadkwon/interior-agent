"""
🏠 인테리어 에이전트 - ADK 표준 메인 에이전트

🚨 **ADK 표준 절대 원칙** 🚨
- 항상 ADK 표준을 100% 준수해야 합니다
- 거짓 정보 없는 정확한 구조만 사용합니다
- 잘못된 구현으로 인한 오류 발생 시 즉시 수정 필요

📋 **메인 에이전트 역할 정의** 📋
┌─────────────────────────────────────────────────────┐
│ 🎯 핵심 역할: 교통 정리원 (라우팅 전담)                    │
├─────────────────────────────────────────────────────┤
│ ✅ 해야 할 일:                                        │
│  1. 사용자 요청 키워드 분석                              │
│  2. 적절한 하위 에이전트로 요청 전달                      │
│  3. 하위 에이전트 응답을 그대로 사용자에게 전달           │
│                                                     │
│ ❌ 절대 하지 말아야 할 일:                               │
│  1. 직접 데이터 처리                                   │
│  2. 직접 Firebase 연결                                │
│  3. 직접 검색이나 필터링                                │
│  4. 응답 내용 수정이나 요약                             │
│  5. 비즈니스 로직 처리                                  │
│                                                     │
│ 🔄 처리 흐름:                                         │
│  사용자 요청 → 키워드 감지 → 하위 에이전트 호출 → 응답 전달  │
└─────────────────────────────────────────────────────┘

🎯 ADK 표준 구조:
- 라우팅 전담: 사용자 요청을 적절한 하위 에이전트에 위임
- sub_agents 패턴: firebase_agent, email_agent, as_agent 관리
- 세션 관리: ADK 표준 세션 서비스 사용
- 도구 없음: 모든 기능은 하위 에이전트가 담당

✨ 95점 ADK 표준 준수:
- 완전한 하위 에이전트 패턴 구현
- ADK 표준 LlmAgent 사용
- 표준 프로젝트 구조 적용
- 커스텀 MCP 클라이언트 (Firebase 제약사항)
- 전문화된 AS 응대 에이전트 추가

🔒 **신뢰성 보장**:
- 모든 기능은 실제 동작하는 것만 구현
- 가짜 또는 시뮬레이션 기능 최소화
- 정확한 타입 annotation 사용
- 완벽한 ADK 표준 준수
"""

from google.adk.agents import LlmAgent
from google.adk.sessions import InMemorySessionService  
from google.adk.runners import Runner
from .agents import firebase_agent, email_agent, as_agent

# ========================================
# 🤖 메인 에이전트 정의 (ADK 표준)
# ========================================

root_agent = LlmAgent(
    model='gemini-2.5-flash-lite-preview-06-17',
    name='interior_agent',
    
    # ========================================
    # 🔀 하위 에이전트 패턴 (ADK 표준)
    # ========================================
    sub_agents=[firebase_agent, email_agent, as_agent],
    
    # ========================================
    # 📋 라우팅 전담 Instructions
    # ========================================
    instruction='''
🏠 인테리어 전문가 메인 에이전트입니다! 

🚨 **절대 규칙: 라우팅 전담! 직접 처리 금지!**
- 나는 라우팅만 담당합니다
- 질문을 받으면 반드시 적절한 하위 에이전트에게 위임해야 합니다
- 절대 직접 답변하지 않습니다

## 🎯 **명확한 라우팅 규칙**

### 🔥 Firebase 키워드 감지 시 → firebase_agent 호출
**키워드**: "조회", "리스트", "목록", "상세", "추가", "수정", "삭제", "컬렉션", "문서", "주소", "견적서", "estimateVersionsV3", "addressesJson", "데이터", "정보", "찾아줘", "검색"
**처리 방법**: 즉시 firebase_agent에게 질문 전달 (instruction으로 한글 포맷팅 자동 처리)

### 📧 Email 키워드 감지 시 → email_agent 호출  
**키워드**: "이메일", "email", "전송", "발송", "메일", "mail", "보내기", "서버", "연결", "테스트", "test"
**처리 방법**: 즉시 email_agent에게 질문 전달

## 🔄 **라우팅 처리 방식**
1. 사용자 질문 분석
2. 키워드 매칭
3. 해당 전문 에이전트 호출
4. 에이전트 응답을 그대로 전달

**예시**:
- "이메일 전송 테스트해줘" → email_agent 호출 (키워드: 이메일, 전송, 테스트)
- "주소 목록 조회해줘" → firebase_agent 호출 (키워드: 주소, 조회) → instruction으로 한글 포맷팅됨
- "8284629 찾아줘" → firebase_agent 호출 (키워드: 찾아줘) → instruction으로 한글 포맷팅됨
- "AS 요청할게요" → as_agent 호출 (키워드: AS 요청)

## ⚠️ **반드시 지켜야 할 것**
- 라우팅 대상이 명확하면 즉시 해당 에이전트 호출
- 응답을 받아서 그대로 사용자에게 전달
- 추가 설명이나 요약 금지
''',
    
    description="Firebase, Email, AS 전문 에이전트들을 관리하는 라우팅 전담 메인 에이전트 (Firebase는 instruction만으로 포맷팅)"
)

# ========================================
# 🏃 Runner 및 세션 서비스 설정 (ADK 표준)
# ========================================

# ADK 표준 세션 서비스
session_service = InMemorySessionService()

# ADK 표준 Runner
runner = Runner(
    agent=root_agent,
    app_name="interior_agent",
    session_service=session_service
)

# ========================================
# 📤 모듈 Export
# ========================================

__all__ = [
    'root_agent',
    'runner', 
    'session_service'
]

# ========================================
# 🚀 초기화 로그
# ========================================

print("="*50)
print("🏠 인테리어 에이전트 초기화 완료!")
print("✅ ADK 표준 구조 (95점 준수)")
print("🔀 라우팅 패턴: Firebase + Email + AS 전문 에이전트")
print("🎯 메인 에이전트: 라우팅 전담")  
print("🔥 Firebase 에이전트: Firestore 전문 처리 + instruction 한글 포맷팅")
print("📧 Email 에이전트: 이메일 전문 처리")
print("🔧 AS 에이전트: 친절한 고객 응대")
print("🔧 MCP 클라이언트: 커스텀 구현 (Firebase 제약)")
print("="*50) 